<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('design-canvas');
  const ctx = canvas.getContext('2d');
  const canvasContainer = document.getElementById('canvas-container');

  const textInput = document.getElementById('text-input');
  const fontSelect = document.getElementById('font-select');
  const fontSizeSlider = document.getElementById('font-size-slider');
  const ringsSlider = document.getElementById('rings-slider');
  const radiusSlider = document.getElementById('radius-slider');
  const spacingSlider = document.getElementById('spacing-slider');
  const textColorPicker = document.getElementById('text-color');
  const bgColorPicker = document.getElementById('bg-color');
  const downloadBtn = document.getElementById('download-btn');

  const fontSizeValue = document.getElementById('font-size-value');
  const ringsValue = document.getElementById('rings-value');
  const radiusValue = document.getElementById('radius-value');
  const spacingValue = document.getElementById('spacing-value');

  let config = {
    text: textInput.value,
    font: fontSelect.value,
    fontSize: parseInt(fontSizeSlider.value),
    rings: parseInt(ringsSlider.value),
    startRadius: parseInt(radiusSlider.value),
    ringSpacing: parseInt(spacingSlider.value),
    textColor: textColorPicker.value,
    bgColor: bgColorPicker.value,
  };

  function resizeCanvas() {
    const size = Math.min(canvasContainer.clientWidth, canvasContainer.clientHeight) * 0.85;
    canvas.width = size;
    canvas.height = size;
    draw(ctx);
  }

  // 文字が重ならないよう、幅→角度へ変換して配置
  function draw(targetCtx = ctx) {
    const c = targetCtx;
    if (!c) return;

    // 背景
    c.fillStyle = config.bgColor;
    c.fillRect(0, 0, canvas.width, canvas.height);

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    // フォント設定は計測前に
    c.font = `${config.fontSize}px "${config.font}"`;
    c.textBaseline = 'middle';
    c.textAlign = 'center';
    c.fillStyle = config.textColor;

    // 任意のトラッキング（字間）px。必要ならUI化
    const tracking = 0;

    for (let j = 0; j < config.rings; j++) {
      const r = config.startRadius + j * config.ringSpacing;

      // 各リングで角度0から開始
      let theta = 0;
      const twopi = Math.PI * 2;
      const s = config.text;

      // 2πに達するまで文字列を繰り返しながら配置
      while (theta < twopi && s.length > 0) {
        for (let k = 0; k < s.length && theta < twopi; k++) {
          const ch = s[k];
          // 幅→角度（弧長 s = rθ ⇒ θ = s/r）
          const w = c.measureText(ch).width + tracking;
          const dTheta = w / r;

          // 文字の中心が弧上に来るよう半分回して描画
          c.save();
          c.translate(centerX, centerY);
          c.rotate(theta + dTheta / 2);
          c.fillText(ch, 0, -r);
          c.restore();

          theta += dTheta;
        }
      }
    }
  }

  function setupEventListeners() {
    const controls = [textInput, fontSelect, fontSizeSlider, ringsSlider, radiusSlider, spacingSlider, textColorPicker, bgColorPicker];
    controls.forEach(control => {
      control.addEventListener('input', () => {
        updateConfig();
        draw(ctx);
      });
    });
    window.addEventListener('resize', resizeCanvas);
    downloadBtn.addEventListener('click', downloadImage);
  }

  function updateConfig() {
    config = {
      text: textInput.value,
      font: fontSelect.value,
      fontSize: parseInt(fontSizeSlider.value),
      rings: parseInt(ringsSlider.value),
      startRadius: parseInt(radiusSlider.value),
      ringSpacing: parseInt(spacingSlider.value),
      textColor: textColorPicker.value,
      bgColor: bgColorPicker.value,
    };
    fontSizeValue.textContent = config.fontSize;
    ringsValue.textContent = config.rings;
    radiusValue.textContent = config.startRadius;
    // 修正: 表示用に ringSpacing を反映
    spacingValue.textContent = config.ringSpacing;
  }

  function downloadImage() {
    const scale = 2;
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');

    tempCanvas.width = canvas.width * scale;
    tempCanvas.height = canvas.height * scale;
    tempCtx.scale(scale, scale);

    // 同じロジックを別コンテキストへ
    draw(tempCtx);

    const link = document.createElement('a');
    link.download = 'circular-text-design.png';
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
  }

  updateConfig();
  resizeCanvas();
  setupEventListeners();
});
</script>
